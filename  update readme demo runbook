[1mdiff --git a/README.md b/README.md[m
[1mindex 28bd751..effa020 100644[m
[1m--- a/README.md[m
[1m+++ b/README.md[m
[36m@@ -1,23 +1,231 @@[m
[31m-# Event-driven game backend demo (Outbox ‚Üí Kafka)[m
[32m+[m[32m# Demo: Transactional Outbox ‚Üí Kafka ‚Üí Consumer (PostgreSQL)[m
 [m
[31m-This repository demonstrates:[m
[31m-- Transactional Outbox (PostgreSQL ‚Üí Kafka)[m
[31m-- Idempotent consumer (dedup by event_id) + retry/backoff + DLQ[m
[31m-- Read-model materialization + replay/recompute[m
[31m-- Alembic migrations and integration tests for key guarantees[m
[32m+[m[32m–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ‚Äî –Ω–µ–±–æ–ª—å—à–æ–π **–¥–µ–º–æ‚Äë–∫–µ–π—Å ‚ÄúTransactional Outbox‚Äù**:[m
[32m+[m[32m1) –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–∏—à–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ `outbox_events` (–≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –¥–æ–º–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏),[m
[32m+[m[32m2) **relay** (`outbox_publisher.py`) –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ –≤ **Kafka**,[m
[32m+[m[32m3) **consumer** (`consumer.py`) —á–∏—Ç–∞–µ—Ç Kafka –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Ñ–∞–∫—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ **PostgreSQL** (`consumed_events`) + (–ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏) –æ–±–Ω–æ–≤–ª—è–µ—Ç read‚Äëmodel.[m
 [m
[31m-## Quickstart[m
[31m-1) Start infrastructure:[m
[31m-```bash[m
[31m-docker compose up -d[m
[32m+[m[32m–¶–µ–ª—å: —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å –º–æ–≥ **–ø–æ–¥–Ω—è—Ç—å –≤—Å—ë –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π** –∏ —É–≤–∏–¥–µ—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª ‚ÄúDB ‚Üí Kafka ‚Üí DB‚Äù.[m
 [m
[31m-2) Install deps:[m
[32m+[m[32m---[m
 [m
[31m-python -m venv .venv[m
[31m-# Windows:[m
[31m-.\.venv\Scripts\Activate.ps1[m
[31m-pip install -r requirements.txt[m
[32m+[m[32m## –ß—Ç–æ –≤–Ω—É—Ç—Ä–∏[m
 [m
[31m-3) Run migrations:[m
[32m+[m[32m- **PostgreSQL 16** (Docker)[m
[32m+[m[32m- **Apache Kafka 3.7.0** (Docker)[m
[32m+[m[32m- **Kafka UI** (Docker) ‚Äî –≤–µ–±‚Äë–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ `http://localhost:8088`[m
[32m+[m[32m- **Alembic migrations** ‚Äî —Å–æ–∑–¥–∞—é—Ç —Ç–∞–±–ª–∏—Ü—ã/–≤—å—é—Ö–∏, –≤–∫–ª—é—á–∞—è:[m
[32m+[m[32m  - `outbox_events` ‚Äî –æ—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π –Ω–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏—é[m
[32m+[m[32m  - `consumed_events` ‚Äî –∂—É—Ä–Ω–∞–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (dedup / exactly-once –Ω–∞ —É—Ä–æ–≤–Ω–µ consumer)[m
[32m+[m[32m- **relay**: `outbox_publisher.py` ‚Äî —á–∏—Ç–∞–µ—Ç `outbox_events`, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Kafka –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –∑–∞–ø–∏—Å—å –≤ `sent`[m
[32m+[m[32m- **consumer**: `consumer.py` ‚Äî —á–∏—Ç–∞–µ—Ç Kafka –∏ –ø–∏—à–µ—Ç —Ñ–∞–∫—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ `consumed_events`[m
 [m
[31m-alembic upgrade head[m
\ No newline at end of file[m
[32m+[m[32m---[m
[32m+[m
[32m+[m[32m## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç (Windows PowerShell)[m
[32m+[m
[32m+[m[32m### 0) –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è[m
[32m+[m[32m- Docker Desktop[m
[32m+[m[32m- PowerShell 5+ / PowerShell 7+[m
[32m+[m[32m- –ü–æ—Ä—Ç—ã —Å–≤–æ–±–æ–¥–Ω—ã: **5432**, **19092**, **8088**[m
[32m+[m
[32m+[m[32m–ü—Ä–æ–≤–µ—Ä–∫–∞:[m
[32m+[m[32m```powershell[m
[32m+[m[32mdocker version[m
[32m+[m[32mdocker compose version[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m---[m
[32m+[m
[32m+[m[32m### 1) –ü–æ–¥–Ω—è—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É (pg + kafka + kafka-ui)[m
[32m+[m[32m```powershell[m
[32m+[m[32mdocker compose up -d pg kafka kafka-ui[m
[32m+[m[32mdocker compose ps[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m**–û–∂–∏–¥–∞–µ–º—ã–π –∏—Ç–æ–≥:**[m
[32m+[m[32m- `pg` = `healthy`[m
[32m+[m[32m- `kafka` –∏ `kafka-ui` = `Up`[m
[32m+[m[32m- Kafka UI –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è: `http://localhost:8088`[m
[32m+[m
[32m+[m[32m---[m
[32m+[m
[32m+[m[32m### 2) –ü—Ä–æ–≥–Ω–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏[m
[32m+[m[32m```powershell[m
[32m+[m[32mdocker compose run --rm migrator[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m**–û–∂–∏–¥–∞–µ–º—ã–π –∏—Ç–æ–≥:** –≤ –ª–æ–≥–∞—Ö `alembic` –µ—Å—Ç—å `upgrade ... -> head` –∏ –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫.[m
[32m+[m
[32m+[m[32m–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü:[m
[32m+[m[32m```powershell[m
[32m+[m[32mdocker compose exec -T pg psql -U postgres -d bot_game_test -c "SELECT tablename FROM pg_tables WHERE schemaname='public' ORDER BY 1;"[m
[32m+[m[32mdocker compose exec -T pg psql -U postgres -d bot_game_test -c "SELECT table_name FROM information_schema.views WHERE table_schema='public' ORDER BY 1;"[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m---[m
[32m+[m
[32m+[m[32m### 3) –ó–∞–ø—É—Å—Ç–∏—Ç—å relay + consumer[m
[32m+[m
[32m+[m[32m> –í–∞–∂–Ω–æ: **consumer** —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∫–∞–∫ Docker image.[m[41m  [m
[32m+[m[32m> –ï—Å–ª–∏ –≤—ã –º–µ–Ω—è–ª–∏ `consumer.py`, –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —Å `--build`, –∏–Ω–∞—á–µ –º–æ–∂–Ω–æ —Å–ª—É—á–∞–π–Ω–æ –ø–æ–¥–Ω—è—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é.[m
[32m+[m
[32m+[m[32m```powershell[m
[32m+[m[32mdocker compose up -d --build relay consumer[m
[32m+[m[32mdocker compose ps[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m**–û–∂–∏–¥–∞–µ–º—ã–π –∏—Ç–æ–≥:**[m
[32m+[m[32m- `relay` = `Up`[m
[32m+[m[32m- `consumer` = `Up`[m
[32m+[m
[32m+[m[32m–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤:[m
[32m+[m[32m```powershell[m
[32m+[m[32mdocker compose logs -n 50 relay[m
[32m+[m[32mdocker compose logs -n 50 consumer[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m---[m
[32m+[m
[32m+[m[32m### 4) –í—Å—Ç–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ outbox_events (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π JSON –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)[m
[32m+[m
[32m+[m[32m–°–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–± ‚Äî `jsonb_build_object`, —á—Ç–æ–±—ã –Ω–µ –ª–æ–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –∫–∞–≤—ã—á–µ–∫.[m
[32m+[m
[32m+[m[32m```powershell[m
[32m+[m[32m$sql = @"[m
[32m+[m[32mINSERT INTO outbox_events[m
[32m+[m[32m(id,event_type,aggregate_type,aggregate_id,payload,created_at,publish_attempts,last_error,published_at,idempotency_key,status)[m
[32m+[m[32mVALUES[m
[32m+[m[32m([m
[32m+[m[32m  gen_random_uuid(),[m
[32m+[m[32m  'game.finished',[m
[32m+[m[32m  'game',[m
[32m+[m[32m  '11111111-1111-1111-1111-111111111111',[m
[32m+[m[32m  jsonb_build_object('game_id','11111111-1111-1111-1111-111111111111','chat_id',-5056821738),[m
[32m+[m[32m  now(),[m
[32m+[m[32m  0,[m
[32m+[m[32m  NULL,[m
[32m+[m[32m  NULL,[m
[32m+[m[32m  concat('demo-', gen_random_uuid()),[m
[32m+[m[32m  'new'[m
[32m+[m[32m);[m
[32m+[m[32m"@[m
[32m+[m
[32m+[m[32m$sql | docker compose exec -T pg psql -U postgres -d bot_game_test -v ON_ERROR_STOP=1[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m**–û–∂–∏–¥–∞–µ–º—ã–π –∏—Ç–æ–≥:** `INSERT 0 1`[m
[32m+[m
[32m+[m[32m–ú–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å:[m
[32m+[m[32m```powershell[m
[32m+[m[32mdocker compose exec -T pg psql -U postgres -d bot_game_test -c "SELECT id, status, created_at, idempotency_key FROM outbox_events ORDER BY created_at DESC LIMIT 5;"[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m---[m
[32m+[m
[32m+[m[32m### 5) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ relay –ø–µ—Ä–µ–≤—ë–ª —Å–æ–±—ã—Ç–∏–µ –≤ sent[m
[32m+[m
[32m+[m[32m```powershell[m
[32m+[m[32mdocker compose exec -T pg psql -U postgres -d bot_game_test -c "SELECT id, status, publish_attempts, last_error, published_at FROM outbox_events ORDER BY created_at DESC LIMIT 1;"[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m**–û–∂–∏–¥–∞–µ–º—ã–π –∏—Ç–æ–≥:** `status = sent`, `published_at` –∑–∞–ø–æ–ª–Ω–µ–Ω.[m
[32m+[m
[32m+[m[32m---[m
[32m+[m
[32m+[m[32m### 6) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ consumer –∑–∞–ø–∏—Å–∞–ª –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ consumed_events[m
[32m+[m
[32m+[m[32m```powershell[m
[32m+[m[32mdocker compose exec -T pg psql -U postgres -d bot_game_test -c "SELECT event_id, event_type, topic, partition, kafka_offset, consumed_at FROM consumed_events ORDER BY consumed_at DESC NULLS LAST LIMIT 10;"[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m**–û–∂–∏–¥–∞–µ–º—ã–π –∏—Ç–æ–≥:** –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞(–∏) –ø–æ `game-events` –∏ `game.finished`.[m
[32m+[m
[32m+[m[32m---[m
[32m+[m
[32m+[m[32m## Smoke test (–æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π)[m
[32m+[m
[32m+[m[32m–ï—Å–ª–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å `smoke.ps1`, –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–∞–∫:[m
[32m+[m[32m```powershell[m
[32m+[m[32mpowershell -ExecutionPolicy Bypass -File .\smoke.ps1[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m**–û–∂–∏–¥–∞–µ–º—ã–π –∏—Ç–æ–≥:** –≤—Å–µ —à–∞–≥–∏ `[OK]`, –Ω–∞ —à–∞–≥–µ 6 –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `consumed_events`.[m
[32m+[m
[32m+[m[32m–ï—Å–ª–∏ smoke –ø–∞–¥–∞–µ—Ç –Ω–∞ —à–∞–≥–µ 6 –∏ –≤ –ª–æ–≥–∞—Ö –µ—Å—Ç—å `NameError`/`TypeError` ‚Äî –ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ —ç—Ç–æ **—Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–∑ consumer**.[m
[32m+[m[32m–†–µ—à–µ–Ω–∏–µ:[m
[32m+[m[32m```powershell[m
[32m+[m[32mdocker compose build consumer[m
[32m+[m[32mdocker compose up -d --force-recreate consumer[m
[32m+[m[32mdocker compose logs -n 80 consumer[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m---[m
[32m+[m
[32m+[m[32m## Replay (–ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ Kafka)[m
[32m+[m
[32m+[m[32m–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é consumer –¥–µ–ª–∞–µ—Ç dedup —á–µ—Ä–µ–∑ `consumed_events`. –î–ª—è ‚Äú–ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–æ–≥–æ–Ω–∞‚Äù –≤ –¥–µ–º–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –≤—Å–µ–≥–æ **—Å–º–µ–Ω–∏—Ç—å consumer group**:[m
[32m+[m
[32m+[m[32m```powershell[m
[32m+[m[32m$env:KAFKA_CONSUMER_GROUP = "game-consumer-replay-$(Get-Date -Format 'yyyyMMddHHmmss')"[m
[32m+[m[32mdocker compose up -d --force-recreate --no-deps consumer[m
[32m+[m[32mdocker compose logs -n 30 consumer[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m**–û–∂–∏–¥–∞–µ–º—ã–π –∏—Ç–æ–≥:** consumer –Ω–∞—á–∏–Ω–∞–µ—Ç —á–∏—Ç–∞—Ç—å —Ç–æ–ø–∏–∫ ‚Äú—Å –Ω—É–ª—è‚Äù –¥–ª—è –Ω–æ–≤–æ–π –≥—Ä—É–ø–ø—ã.[m
[32m+[m
[32m+[m[32m---[m
[32m+[m
[32m+[m[32m## Troubleshooting[m
[32m+[m
[32m+[m[32m### 1) –û—à–∏–±–∫–∞ JSON –≤ INSERT[m
[32m+[m[32m–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ `invalid input syntax for type json` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `jsonb_build_object` (—Å–º. —à–∞–≥ 4) –∏–ª–∏ `$sql` here‚Äëstring.[m
[32m+[m
[32m+[m[32m### 2) consumer –ø–∞–¥–∞–µ—Ç, –Ω–æ relay –ø–µ—Ä–µ–≤–æ–¥–∏—Ç outbox –≤ sent[m
[32m+[m[32m–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:[m
[32m+[m[32m```powershell[m
[32m+[m[32mdocker compose logs -n 120 consumer[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m–¢–∏–ø–æ–≤—ã–µ –ø—Ä–∏—á–∏–Ω—ã:[m
[32m+[m[32m- –∑–∞–±—ã–ª–∏ `--build` –ø–æ—Å–ª–µ –ø—Ä–∞–≤–æ–∫ –≤ `consumer.py`[m
[32m+[m[32m- –Ω–µ–≤–µ—Ä–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–≤ Docker –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å `pg:5432` –∏ `kafka:19092`)[m
[32m+[m
[32m+[m[32m### 3) –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ consumer.py (–±–µ–∑ Docker)[m
[32m+[m[32m–õ–æ–∫–∞–ª—å–Ω–æ –Ω—É–∂–Ω–æ —è–≤–Ω–æ –∑–∞–¥–∞—Ç—å env:[m
[32m+[m[32m```powershell[m
[32m+[m[32m$env:DATABASE_URL = "postgresql://postgres:postgres@localhost:5432/bot_game_test"[m
[32m+[m[32m$env:KAFKA_BOOTSTRAP_SERVERS = "localhost:19092"[m
[32m+[m[32mpython consumer.py[m
[32m+[m[32m```[m
[32m+[m[32m–í –¥–µ–º–æ –¥–ª—è —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥—É—é **–≤—Å—ë —á–µ—Ä–µ–∑ Docker**, —Ç–∞–∫ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ.[m
[32m+[m
[32m+[m[32m---[m
[32m+[m
[32m+[m[32m## –ö–∞–∫ –∑–∞–ª–∏—Ç—å –Ω–∞ GitHub (–∫–æ—Ä–æ—Ç–∫–æ)[m
[32m+[m
[32m+[m[32m1) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç:[m
[32m+[m[32m```powershell[m
[32m+[m[32mgit status[m
[32m+[m[32mpowershell -ExecutionPolicy Bypass -File .\smoke.ps1[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m2) –î–æ–±–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è:[m
[32m+[m[32m```powershell[m
[32m+[m[32mgit add .[m
[32m+[m[32mgit diff --staged[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m3) –ö–æ–º–º–∏—Ç:[m
[32m+[m[32m```powershell[m
[32m+[m[32mgit commit -m "docs: add runbook + smoke demo"[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m4) –ü—É—à:[m
[32m+[m[32m```powershell[m
[32m+[m[32mgit remote add origin <URL_–í–ê–®–ï–ì–û_REPO>[m
[32m+[m[32mgit branch -M main[m
[32m+[m[32mgit push -u origin main[m
[32m+[m[32m```[m
[32m+[m
[32m+[m[32m**–û–∂–∏–¥–∞–µ–º—ã–π –∏—Ç–æ–≥:** –≤ GitHub –ø–æ—è–≤–ª—è–µ—Ç—Å—è README, docker-compose, —Å–∫—Ä–∏–ø—Ç—ã –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞.[m
[1mdiff --git a/fix_consumer.patch b/fix_consumer.patch[m
[1mnew file mode 100644[m
[1mindex 0000000..fab71d0[m
[1m--- /dev/null[m
[1m+++ b/fix_consumer.patch[m
[36m@@ -0,0 +1,62 @@[m
[32m+[m[32mdiff --git a/consumer.py b/consumer.py[m
[32m+[m[32m--- a/consumer.py[m
[32m+[m[32m+++ b/consumer.py[m
[32m+[m[32m@@[m
[32m+[m[32m def mark_consumed([m
[32m+[m[32m     db,[m
[32m+[m[32m     *,[m
[32m+[m[32m     event_id,[m
[32m+[m[32m     topic: str,[m
[32m+[m[32m     partition: int,[m
[32m+[m[32m     offset: int,[m
[32m+[m[32m     aggregate_type,[m
[32m+[m[32m     aggregate_id,[m
[32m+[m[32m     event_type,[m
[32m+[m[32m ):[m
[32m+[m[32m-    db.execute([m
[32m+[m[32m-        sql_text([m
[32m+[m[32m-            """[m
[32m+[m[32m-            INSERT INTO consumed_events (event_id, topic, "partition", kafka_offset, aggregate_type, aggregate_id, event_type, consumed_at)[m
[32m+[m[32m-            VALUES (CAST(:event_id AS uuid), :topic, :partition, :kafka_offset, :aggregate_type, CAST(:aggregate_id AS uuid), :event_type, now())[m
[32m+[m[32m-            ON CONFLICT (event_id) DO NOTHING[m
[32m+[m[32m-            """[m
[32m+[m[32m-        ),[m
[32m+[m[32m-        {[m
[32m+[m[32m-            "event_id": str(event_id),[m
[32m+[m[32m-            "topic": topic,[m
[32m+[m[32m-            "partition": partition,[m
[32m+[m[32m-            "kafka_offset": offset,[m
[32m+[m[32m-            "aggregate_type": agg_type,[m
[32m+[m[32m-            "aggregate_id": agg_id,[m
[32m+[m[32m-            "event_type": event_type,[m
[32m+[m[32m-        },[m
[32m+[m[32m-    )[m
[32m+[m[32m+    try:[m
[32m+[m[32m+        db.execute([m
[32m+[m[32m+            sql_text([m
[32m+[m[32m+                """[m
[32m+[m[32m+                INSERT INTO consumed_events (event_id, topic, "partition", kafka_offset, aggregate_type, aggregate_id, event_type, consumed_at)[m
[32m+[m[32m+                VALUES (CAST(:event_id AS uuid), :topic, :partition, :kafka_offset, :aggregate_type, CAST(:aggregate_id AS uuid), :event_type, now())[m
[32m+[m[32m+                ON CONFLICT (event_id) DO NOTHING[m
[32m+[m[32m+                """[m
[32m+[m[32m+            ),[m
[32m+[m[32m+            {[m
[32m+[m[32m+                "event_id": str(event_id),[m
[32m+[m[32m+                "topic": topic,[m
[32m+[m[32m+                "partition": partition,[m
[32m+[m[32m+                "kafka_offset": offset,[m
[32m+[m[32m+                "aggregate_type": aggregate_type,[m
[32m+[m[32m+                "aggregate_id": aggregate_id,[m
[32m+[m[32m+                "event_type": event_type,[m
[32m+[m[32m+            },[m
[32m+[m[32m+        )[m
[32m+[m[32m+        db.commit()[m
[32m+[m[32m+    except Exception:[m
[32m+[m[32m+        db.rollback()[m
[32m+[m[32m+        raise[m
[32m+[m[32m@@[m
[32m+[m[32m-def publish_dlq(dlq, *, topic: str, record, msg: dict | None, err: Exception, attempt: int, reason: str):[m
[32m+[m[32m+def publish_dlq(dlq, *, topic: str, record, msg: dict | None, err: Exception, attempt: int, reason: str = "unknown"):[m
[32m+[m[32m@@[m
[32m+[m[32m-    publish_dlq(dlq, topic=DLQ_TOPIC, record=record, msg=msg, err=e, attempt=attempt)[m
[32m+[m[32m+    publish_dlq(dlq, topic=DLQ_TOPIC, record=record, msg=msg, err=e, attempt=attempt, reason=f"exception:{type(e).__name__}")[m
\ No newline at end of file[m
